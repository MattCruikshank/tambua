<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambua Server Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .header {
            background: #16162a;
            padding: 16px 24px;
            border-bottom: 1px solid #2a2a4a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 20px; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .section {
            background: #1e1e3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section h2 { font-size: 18px; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #4a4a8a; color: white; }
        .btn-primary:hover { background: #5a5a9a; }
        .btn-danger { background: #8a4a4a; color: white; }
        .btn-danger:hover { background: #9a5a5a; }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #aaa; font-size: 14px; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #2a2a4a;
            border: 1px solid #3a3a5a;
            border-radius: 4px;
            color: #eee;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #5a5a9a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #2a2a4a;
        }
        th { color: #888; font-weight: 500; font-size: 14px; }
        .actions { display: flex; gap: 8px; }
        .empty { color: #666; text-align: center; padding: 24px; }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
        }
        .tab {
            padding: 10px 20px;
            background: #1e1e3a;
            border: none;
            border-radius: 4px 4px 0 0;
            color: #888;
            cursor: pointer;
        }
        .tab.active { background: #2a2a4a; color: #eee; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .category-section {
            background: #16162a;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .category-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .category-header:hover { background: #1e1e3a; }
        .channel-list { padding: 0 16px 12px; }
        .channel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1e1e3a;
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .channel-name::before { content: '# '; color: #666; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1e1e3a;
            padding: 24px;
            border-radius: 8px;
            width: 450px;
            max-width: 90%;
        }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Tambua Server Admin</h1>
        <span id="serverName"></span>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('server')">Server Info</button>
            <button class="tab" onclick="switchTab('channels')">Channels</button>
            <button class="tab" onclick="switchTab('groups')">Groups</button>
        </div>

        <div id="server" class="tab-content active">
            <div class="section">
                <h2>Server Settings</h2>
                <form id="serverForm" onsubmit="saveServerInfo(event)">
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="displayName" placeholder="My Server">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="description" rows="3" placeholder="A brief description of this server"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Icon URL</label>
                        <input type="text" id="iconUrl" placeholder="https://...">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>

        <div id="channels" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Categories & Channels</h2>
                    <button class="btn btn-primary" onclick="showAddCategory()">Add Category</button>
                </div>
                <div id="categoryList"></div>
            </div>
        </div>

        <div id="groups" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Groups</h2>
                    <button class="btn btn-primary" onclick="showAddGroup()">Add Group</button>
                </div>
                <table>
                    <thead>
                        <tr><th>Name</th><th>Members</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="groupList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h3 id="categoryModalTitle">Add Category</h3>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <input type="hidden" id="categoryId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <input type="number" id="categoryPosition" value="0">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="hideModal('categoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="channelModal">
        <div class="modal-content">
            <h3>Add Channel</h3>
            <form id="channelForm" onsubmit="saveChannel(event)">
                <input type="hidden" id="channelCategoryId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="channelName" required>
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <input type="number" id="channelPosition" value="0">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="hideModal('channelModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <h3>Add Group</h3>
            <form id="groupForm" onsubmit="saveGroup(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="groupName" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="hideModal('groupModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let categories = [];
        let groups = [];

        async function api(path, options = {}) {
            const res = await fetch('/api' + path, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers }
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({ error: res.statusText }));
                throw new Error(err.error);
            }
            if (res.status === 204) return null;
            return res.json();
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${name}')"]`).classList.add('active');
            document.getElementById(name).classList.add('active');
        }

        async function loadServerInfo() {
            try {
                const info = await api('/server');
                document.getElementById('displayName').value = info.display_name || '';
                document.getElementById('description').value = info.description || '';
                document.getElementById('iconUrl').value = info.icon_url || '';
                document.getElementById('serverName').textContent = info.display_name || 'Tambua Server';
            } catch (e) {
                console.error('Failed to load server info:', e);
            }
        }

        async function saveServerInfo(e) {
            e.preventDefault();
            try {
                await api('/server', {
                    method: 'PUT',
                    body: JSON.stringify({
                        id: 'default',
                        display_name: document.getElementById('displayName').value,
                        description: document.getElementById('description').value,
                        icon_url: document.getElementById('iconUrl').value
                    })
                });
                loadServerInfo();
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        async function loadCategories() {
            try {
                categories = await api('/categories') || [];
                for (const cat of categories) {
                    cat.channels = await api('/channels?category_id=' + cat.id) || [];
                }
                renderCategories();
            } catch (e) {
                console.error('Failed to load categories:', e);
            }
        }

        function renderCategories() {
            const container = document.getElementById('categoryList');
            if (!categories.length) {
                container.innerHTML = '<div class="empty">No categories yet</div>';
                return;
            }
            container.innerHTML = categories.map(cat => `
                <div class="category-section">
                    <div class="category-header">
                        <span>${cat.name}</span>
                        <div class="actions">
                            <button class="btn btn-primary btn-small" onclick="showAddChannel('${cat.id}')">Add Channel</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="channel-list">
                        ${(cat.channels || []).map(ch => `
                            <div class="channel-item">
                                <span class="channel-name">${ch.name}</span>
                                <div class="actions">
                                    <button class="btn btn-small" onclick="clearChannel('${ch.id}')">Clear</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteChannel('${ch.id}')">Delete</button>
                                </div>
                            </div>
                        `).join('') || '<div class="empty">No channels</div>'}
                    </div>
                </div>
            `).join('');
        }

        function showAddCategory() {
            document.getElementById('categoryModalTitle').textContent = 'Add Category';
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryPosition').value = categories.length;
            showModal('categoryModal');
        }

        async function saveCategory(e) {
            e.preventDefault();
            try {
                await api('/categories', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('categoryName').value,
                        position: parseInt(document.getElementById('categoryPosition').value)
                    })
                });
                hideModal('categoryModal');
                loadCategories();
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category and all its channels?')) return;
            try {
                await api('/categories/' + id, { method: 'DELETE' });
                loadCategories();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        function showAddChannel(categoryId) {
            document.getElementById('channelCategoryId').value = categoryId;
            document.getElementById('channelName').value = '';
            const cat = categories.find(c => c.id === categoryId);
            document.getElementById('channelPosition').value = (cat?.channels?.length || 0);
            showModal('channelModal');
        }

        async function saveChannel(e) {
            e.preventDefault();
            try {
                await api('/channels', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('channelName').value,
                        category_id: document.getElementById('channelCategoryId').value,
                        position: parseInt(document.getElementById('channelPosition').value)
                    })
                });
                hideModal('channelModal');
                loadCategories();
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        async function deleteChannel(id) {
            if (!confirm('Delete this channel?')) return;
            try {
                await api('/channels/' + id, { method: 'DELETE' });
                loadCategories();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        async function clearChannel(id) {
            if (!confirm('Clear all messages from this channel?')) return;
            try {
                await api('/channels/' + id + '/clear', { method: 'POST' });
                alert('Messages cleared');
            } catch (e) {
                alert('Failed to clear: ' + e.message);
            }
        }

        async function loadGroups() {
            try {
                groups = await api('/groups') || [];
                renderGroups();
            } catch (e) {
                console.error('Failed to load groups:', e);
            }
        }

        function renderGroups() {
            const tbody = document.getElementById('groupList');
            if (!groups.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">No groups yet</td></tr>';
                return;
            }
            tbody.innerHTML = groups.map(g => `
                <tr>
                    <td>${g.name}</td>
                    <td>${(g.members || []).length} members</td>
                    <td class="actions">
                        <button class="btn btn-danger btn-small" onclick="deleteGroup('${g.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddGroup() {
            document.getElementById('groupName').value = '';
            showModal('groupModal');
        }

        async function saveGroup(e) {
            e.preventDefault();
            try {
                await api('/groups', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('groupName').value
                    })
                });
                hideModal('groupModal');
                loadGroups();
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        async function deleteGroup(id) {
            if (!confirm('Delete this group?')) return;
            try {
                await api('/groups/' + id, { method: 'DELETE' });
                loadGroups();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        document.querySelectorAll('.modal').forEach(m => {
            m.onclick = (e) => { if (e.target === m) hideModal(m.id); };
        });

        loadServerInfo();
        loadCategories();
        loadGroups();
    </script>
</body>
</html>
